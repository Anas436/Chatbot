{% extends 'base.html' %}

{% block styles %}
<style>
    body, html {
      height: 100%;
    }

    .messages-box {
      flex: 1;
      overflow-y: auto;
    }

    .messages-list {
      padding-left: 0;
    }

    .message {
      margin-bottom: 15px;
      list-style: none;
    }

    .message-text {
      padding: 10px;
      border-radius: 5px;
    }

    .sent {
      background-color: #dcf8c6;
      align-self: flex-end;
    }

    .received {
      background-color: #f1f0f0;
      align-self: flex-start;
    }

    .message-form {
      /* REMOVE: display: flex; from here */
      position: fixed;
      bottom: 0;
      left: 0;
      right: 0;
      padding: 10px;
      background-color: #f8f9fa;

      /* Use flex to center the wrapper content */
      display: flex; 
      justify-content: center;
    }
    
    /* To hold the input group and the buttons */
    .form-content-wrapper {
        display: flex;
        flex-direction: column; /* Stack input and buttons vertically */
        gap: 5px; /* Spacing between input and buttons */

        /* Ensure the wrapper doesn't take up the full width, center it with a max-width if needed */
        width: 100%;
        max-width: 800px; /* Example: set a max width for centering */
    }

    /* To hold the two new buttons */
    .form-buttons-wrapper {
        display: flex;
        justify-content: center; /* Align buttons to the right */
        gap: 10px; /* Spacing between buttons */
        padding-top: 5px; /* Optional: adds a little space above the buttons */
    }

    /* To make both buttons the same size */
    .btn-equal-width {
        flex-grow: 1; /* Allows buttons to take equal space */
        max-width: 110px; /* Limit the maximum width of each button for centering effect */
    }

    .message-input {
      flex: 1;
      border-radius: 0;
      border-right: none;
    }

    .btn-send {
      border-radius: 0;
    }
    
    /* For the delete button to stand out */
    .btn-delete {
        /* Add styles as needed, using Bootstrap danger color is common */
        background-color: #dc3545; /* Bootstrap danger color */
        border-color: #dc3545;
        color: white;
    }
    
    /* For the logout button */
    .btn-logout {
        /* Add styles as needed, using Bootstrap secondary or primary */
        background-color: #6c757d; /* Bootstrap secondary color */
        border-color: #6c757d;
        color: white;
    }

    .chat-container {
      height: 100%;
      display: flex;
      flex-direction: column;

      /* Set a max width (e.g., 800px) and center the container */
      max-width: 1100px; /* Adjust this value to control the chat width */
      margin: 0 auto; /* This centers the container horizontally */
    }

    /* Ensure the card only takes up the available centered space */
    .card {
        width: 100%;
        /* ADD THIS LINE to remove the border */
        border: none; 
        /* You might also want to remove the default box-shadow if it's noticeable */
        box-shadow: none;
    }


    /* Adjust the message input to remove the rounded corner on the left */
    .message-input {
      flex: 1;
      border-top-left-radius: 0.25rem; /* Keep default Bootstrap corner */
      border-bottom-left-radius: 0.25rem; /* Keep default Bootstrap corner */
      border-right: none;
    }

    /* Adjust the form input area to be flexible to accommodate the token */
    .input-group {
        width: 100%; /* Ensure input group fills its container */
        /* Make it flexible to align the token next to it */
        flex-wrap: nowrap; 
    }


    /* STYLES FOR MARKDOWN RENDERING */
    .message-content {
        /* Set a comfortable line height for the text content */
        line-height: 1.6;
        /* Allow overflow content to be scrollable horizontally if necessary */
        overflow-x: auto; 
    }

    /* Style for Headers (to make them stand out) */
    .message-content h3, 
    .message-content h4 {
        margin-top: 15px;
        margin-bottom: 8px;
        font-weight: bold;
        border-bottom: 1px solid #dee2e6; /* Light separator */
        padding-bottom: 4px;
    }

    /* Style for Tables (crucial for clean structure) */
    .message-content table {
        width: 100%;
        border-collapse: collapse;
        margin: 10px 0;
        /* Ensure table text wraps correctly */
        word-break: break-word; 
    }

    .message-content th, 
    .message-content td {
        padding: 8px;
        border: 1px solid #ccc;
        text-align: left;
        vertical-align: top;
        /* Ensure table content is readable */
        font-size: 0.9em; 
    }

    .message-content th {
        background-color: #e9ecef; /* Light gray background for headers */
        font-weight: bold;
    }

    /* Style for code blocks (if they are generated) */
    .message-content pre {
        background-color: #f8f9fa;
        border: 1px solid #e9ecef;
        padding: 10px;
        border-radius: 5px;
        overflow-x: auto;
    }




    .typing-indicator {
        display: flex;
        align-items: center;
        gap: 3px;
    }

    .typing-indicator span {
        height: 8px;
        width: 8px;
        background-color: #6c757d;
        border-radius: 50%;
        display: inline-block;
        animation: typing 1.4s infinite ease-in-out;
    }

    .typing-indicator span:nth-child(1) { animation-delay: -0.32s; }
    .typing-indicator span:nth-child(2) { animation-delay: -0.16s; }

    @keyframes typing {
        0%, 80%, 100% { transform: scale(0); }
        40% { transform: scale(1); }
    }

  </style>
{% endblock %}


{% block content %}
<div class="chat-container">
  <div class="card flex-grow-1">

    <div class="card-body messages-box">
      
      <ul class="list-unstyled messages-list">
        
        {% for chat in chats %}
          {% if chat.user == request.user %}

        <li class="message sent">
          <div class="message-text">
            <div class="message-sender">
              <b>You</b>
            </div>
            <div class="message-content">
              {{chat.message}}
            </div>
          </div>
        </li>

        <li class="message received">
          <div class="message-text">
            <div class="message-sender">
              <b>DocuMind</b>
            </div>
            <div class="message-content" id="response-{{ chat.id }}">
              {{chat.response}}
            </div>
          </div>
        </li>

          {% endif %}
        {% endfor %}
        
      </ul>
      
    </div>
    <br><br>
    <br><br>
    <br><br>
  </div>

  <form class="message-form">
      {%csrf_token%}
      <div class="form-content-wrapper">
        <!-- File attachment section removed -->
        
        <div class="input-group">
          <!-- File input and upload button removed -->
          
          <input type="text" class="form-control message-input" placeholder="Ask DocuMind...">
          
          <div class="input-group-append">
            <button type="submit" class="btn btn-primary btn-send">Send</button>
          </div>
        </div>
        <div class="form-buttons-wrapper">
          {% if user.is_authenticated %}
            <button type="button" id="delete-chat-btn" class="btn btn-delete btn-equal-width">Delete Chat</button> 
            <a href="logout" class="btn btn-logout btn-equal-width" role="button">Logout</a>
          {% endif %}
        </div>
      </div>
  </form>

</div>


<script>
  const messagesList = document.querySelector('.messages-list');
  const messageForm = document.querySelector('.message-form');
  const messageInput = document.querySelector('.message-input');
  
  // HELPER FUNCTION: To render markdown content
  function renderMarkdown(markdownText) {
      // Use marked.parse to convert markdown to HTML
      return marked.parse(markdownText || '');
  }
  
  // Render the chat history upon page load
  document.addEventListener('DOMContentLoaded', () => {
    // Loop through all existing response elements and render their markdown
    const historyResponses = document.querySelectorAll('.message.received .message-content');
    historyResponses.forEach(contentDiv => {
        const rawMarkdown = contentDiv.textContent.trim();
        // Replace the raw text content with the rendered HTML
        contentDiv.innerHTML = renderMarkdown(rawMarkdown); 
    });
    
    // Scroll to the bottom of the messages list on load
    const messagesBox = document.querySelector('.messages-box');
    messagesBox.scrollTop = messagesBox.scrollHeight;
  });

  // Form submit event handler - SIMPLIFIED VERSION
  messageForm.addEventListener('submit', async (event) => {
      event.preventDefault();

      const message = messageInput.value.trim();

      if (!message) {
          return; // Don't send empty messages
      }

      // Display user message
      const userMessageContent = renderMarkdown(message);
      const messageItem = document.createElement('li');
      messageItem.classList.add('message', 'sent');
      messageItem.innerHTML = `
          <div class="message-text">
              <div class="message-sender">
                  <b>You</b>
              </div>
              <div class="message-content">
                  ${userMessageContent}
              </div>
          </div>`;
      messagesList.appendChild(messageItem);

      // Clear input
      messageInput.value = '';

      // Create loading message
      const loadingItem = document.createElement('li');
      loadingItem.classList.add('message', 'received');
      loadingItem.id = 'loading-message';
      loadingItem.innerHTML = `
          <div class="message-text">
              <div class="message-sender">
                  <b>DocuMind</b>
              </div>
              <div class="message-content">
                  <div class="typing-indicator">
                      <span></span>
                      <span></span>
                      <span></span>
                  </div>
              </div>
          </div>
      `;
      messagesList.appendChild(loadingItem);
      messagesList.lastElementChild.scrollIntoView({ behavior: 'smooth' });

      // Use streaming approach
      const useStreaming = true;

      if (useStreaming) {
          await handleStreamingResponse(message);
      } else {
          handleRegularResponse(message);
      }
  });

  // Streaming response handler - SIMPLIFIED
  async function handleStreamingResponse(message) {
      try {
          const formData = new FormData();
          formData.append('message', message);
          formData.append('csrfmiddlewaretoken', document.querySelector('[name=csrfmiddlewaretoken]').value);

          const response = await fetch('/stream_chat/', {
              method: 'POST',
              body: formData
          });

          if (!response.ok) {
              throw new Error('Stream request failed');
          }

          const reader = response.body.getReader();
          const decoder = new TextDecoder();
          
          // Remove loading message
          document.getElementById('loading-message')?.remove();
          
          // Create streaming response element
          const responseItem = document.createElement('li');
          responseItem.classList.add('message', 'received');
          responseItem.innerHTML = `
              <div class="message-text">
                  <div class="message-sender">
                      <b>DocuMind</b>
                  </div>
                  <div class="message-content" id="streaming-response">
                  </div>
              </div>
          `;
          messagesList.appendChild(responseItem);
          
          const responseContent = document.getElementById('streaming-response');
          let fullResponse = '';
          let buffer = '';

          while (true) {
              const { done, value } = await reader.read();
              if (done) break;
              
              const chunk = decoder.decode(value, { stream: true });
              buffer += chunk;
              
              const lines = buffer.split('\n');
              buffer = lines.pop() || ''; // Keep incomplete line in buffer
              
              for (const line of lines) {
                  if (line.trim() === '') continue;
                  if (line.startsWith('data: ')) {
                      const word = line.slice(6).trim();
                      if (word) {
                          fullResponse += word + ' ';
                          responseContent.textContent = fullResponse;
                          // Scroll to the latest message
                          responseItem.scrollIntoView({ behavior: 'smooth', block: 'nearest' });
                      }
                  }
              }
          }

          // Process any remaining buffer
          if (buffer.trim() && buffer.startsWith('data: ')) {
              const word = buffer.slice(6).trim();
              if (word) {
                  fullResponse += word + ' ';
                  responseContent.textContent = fullResponse;
              }
          }

          // Convert final response to markdown
          if (fullResponse.trim()) {
              responseContent.innerHTML = renderMarkdown(fullResponse);
          }
          
      } catch (error) {
          console.error('Stream Error:', error);
          handleErrorResponse();
      }
  }

  // Regular response handler - SIMPLIFIED
  function handleRegularResponse(message) {
      const formData = new FormData();
      formData.append('message', message);
      formData.append('csrfmiddlewaretoken', document.querySelector('[name=csrfmiddlewaretoken]').value);

      fetch('', {
          method: 'POST',
          body: formData
      })
        .then(response => response.json())
        .then(data => {
            const loadingMessage = document.getElementById('loading-message');
            if (loadingMessage && loadingMessage.parentNode) {
                loadingMessage.parentNode.removeChild(loadingMessage);
            }
            
            const renderedResponse = renderMarkdown(data.response);
            const responseItem = document.createElement('li');
            responseItem.classList.add('message', 'received');
            responseItem.innerHTML = `
                <div class="message-text">
                    <div class="message-sender">
                        <b>DocuMind</b>
                    </div>
                    <div class="message-content">
                        ${renderedResponse}
                    </div>
                </div>
            `;
            messagesList.appendChild(responseItem);
            messagesList.lastElementChild.scrollIntoView({ behavior: 'smooth' });
        })
        .catch(error => {
            console.error('Fetch Error:', error);
            handleErrorResponse();
        });
  }

  function handleErrorResponse() {
      document.getElementById('loading-message')?.remove();
      const errorItem = document.createElement('li');
      errorItem.classList.add('message', 'received');
      errorItem.innerHTML = `
          <div class="message-text">
              <div class="message-sender">
                  <b>DocuMind</b>
              </div>
              <div class="message-content" style="color: red;">
                  Error: Failed to get response.
              </div>
          </div>`;
      messagesList.appendChild(errorItem);
  }

  // Delete Chat Button functionality (unchanged)
  const deleteChatBtn = document.getElementById('delete-chat-btn');
  
  function showDeleteFeedback(buttonElement, success) {
      const originalText = 'Delete Chat';
      const successText = 'Deleting...';
      const failureText = 'Error!';

      buttonElement.disabled = true;

      if (success) {
          buttonElement.textContent = successText;
      } else {
          buttonElement.textContent = failureText;
      }

      setTimeout(() => {
          buttonElement.textContent = originalText;
          buttonElement.disabled = false;
      }, 2000);
  }

  if (deleteChatBtn) {
    deleteChatBtn.addEventListener('click', () => {
      
      deleteChatBtn.disabled = true;
      deleteChatBtn.textContent = 'Deleting...';

      fetch('/delete_chat/', {
          method: 'POST',
          headers: { 'Content-Type': 'application/x-www-form-urlencoded' },
          body: new URLSearchParams({
            'csrfmiddlewaretoken': document.querySelector('[name=csrfmiddlewaretoken]').value
          })
        })
          .then(response => {
            if (response.status === 204) {
              messagesList.innerHTML = ''; 
              showDeleteFeedback(deleteChatBtn, true); 
            } else {
              showDeleteFeedback(deleteChatBtn, false);
            }
          })
          .catch(error => {
            console.error('Error:', error);
            showDeleteFeedback(deleteChatBtn, false);
          })
      
    });
  }

</script>

{% endblock %}